<!DOCTYPE html>
<html lang=ko>
    <head>
        <meta name="viewport"> 
        <meta charset="utf-8">
        <style> 
            @import url('https://fonts.googleapis.com/css?family=Permanent+Marker');
            @import url('https://fonts.googleapis.com/css?family=Staatliches');
            #title{
                font-family: 'Staatliches', cursive;
                color:brown
            }
            td{
                /* width:2px; */
                align-items:center;
            }
            .class-button{
                width:90px;   
            }
            .box{
                text-align: center;
            }
        </style>

    </head>
    <body>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

        <br/>

        <div align="center">
            <h1 id='title'>Artistpizza class board</h1>
        </div>
        <table id="table" class="mdl-data-table mdl-shadow--2dp" align="center">
            <thead>
                <!-- 0 -->
                <tr id="class-day-row">
                    <th></th>
                    <th>
                        <div class="box">
                            <button class="mdl-button" disabled>목요일</button>
                        </div>
                    </th>
                    <th>
                        <div class="box">
                            <button class="mdl-button" disabled>금요일</button>
                        </div>
                    </th>
                    <th>
                        <div class="box">
                            <button class="mdl-button" disabled>토요일</button>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="class-table-body">
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <div class="box">
                            <button 
                            class="mdl-button mdl-js-button">master(전문가과정)</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="box">
                            <button class="mdl-button" disabled>12-2시</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button 
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button 
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button  
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="box">
                            <button class="mdl-button" disabled>2-4시</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button 
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="금_2-4시_수채화" 
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button id="금_2-4시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="토_2-4시_수채화" 
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button id="토_2-4시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <div>
                            <button class="mdl-button" disabled> </button>
                        </div>
                    </td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <!-- 5 -->
                <tr>
                    <td>
                        <div class="box">
                            <button class="mdl-button" disabled>6-8시</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="목_6-8시_수채화"  
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button id="목_6-8시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="금_6-8시_수채화"  
                            class="mdl-button mdl-js-button class-button">수채화</button>
                            <button id="금_6-8시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div class="box">
                            <button
                            class="mdl-button mdl-js-button">원데이클래스</button>
                        </div>
                    </td>
                </tr>
                <!-- 6 -->
                <tr>
                    <td>
                        <div class="box">
                            <button class="mdl-button" disabled>8-10시</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="목_8-10시_소묘드로잉" 
                             class="mdl-button mdl-js-button class-button">소묘드로잉</button>
                            <button id="목_8-10시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                        <div>
                            <button id="금_8-10시_소묘드로잉" 
                             class="mdl-button mdl-js-button class-button">소묘드로잉</button>
                            <button id="금_8-10시_유화" 
                            class="mdl-button mdl-js-button class-button">유화</button>
                        </div>
                    </td>
                    <td>
                    </td>
                </tr>
            </tbody>
        </table>


        <dialog class="mdl-dialog">
          <h4 class="mdl-dialog__title">출석부</h4>
          <div class="mdl-dialog__content">
              <table class="mdl-data-table" width="100%">
                  <thead>
                      <tr>
                          <th>이름</th>
                          <th>출석</th>
                      </tr>
                  </thead>
                  <tbody id="rollbook">
                  </tbody>
              </table>
          </div>
          <div class="mdl-dialog__actions">
            <!-- <button type="button" class="mdl-button">Agree</button> -->
            <button type="button" class="mdl-button close">close</button>
          </div>
        </dialog>

        <script src="mdl/material.min.js"></script>
    
        <script src="dialog-polyfill.js"></script>
        

        <script>
            const url = 'http://0.0.0.0:5000/api/'
            var weekData
            var prepared = false

            // $.getJSON(url,function(result){
            //     weekData = result
            // } )

            const userAction = async () => {
                const response = await fetch(url+'weekdata')
                weekData = await response.json() //extract JSON from the http response
  // do something with myJson
            }
            userAction()


            async function updateWeekData(){
                // const response = await
                const response = await fetch(url+'weekdata', {
                    method: 'PUT',
                    body: JSON.stringify(weekData), // string or object
                    headers:{
                        'Content-Type': 'application/json;charset=UTF-8'
                    }
                });
                console.log(response)
            }

            async function getRollbook(day, time, course){
                const response = await fetch(url + '')
            }


            async function postChangeRequest(from, to, name){
                var request
                request.from = from
                request.to = to
                request.name = name
                const response = await fetch(url+'weekclass', {
                    method: 'POST',
                    body: request, // string or object
                    headers:{
                        'Content-Type': 'application/json'
                    }
                });
                weekData = await response.json();
            }


            var oDay, oTime ,oCourse, changer


            function showRollbook(day, time, course){
                // alert(day + time + course)
                oDay = day
                oTime = time
                oCourse = course
                showClassState(day, time, course)
            }

            function changeDay(nDay, nTime, nCourse) {
                alert("change day from "+oDay+oTime+oCourse+" to "+nDay+nTime+nCourse+" changer is" + changer)
                
                weekData[nDay][nTime][nCourse][changer] = weekData[oDay][oTime][oCourse][changer]
                delete weekData[oDay][oTime][oCourse][changer]
                
                // var from, to , name
                // from.day = oDay
                // from.time = oTime
                // from.course = oCourse

                // to.day = nDay
                // to.time = nTime
                // to.course = nCourse

                updateWeekData(weekData)

                setOnclickOnTable()
            }

            function setChangeDayMode(name){
                changer = name
                table = document.getElementById("table")
                dayRow = document.getElementById("class-day-row").getElementsByTagName("th")

                tbody = document.getElementById("class-table-body")
                rows = tbody.getElementsByTagName("tr")
                for(k=0;k<rows.length;k++){
                    cells = rows[k].getElementsByTagName("td")
                    if(cells[0].getElementsByTagName("button").length==0)continue
                    time = cells[0].getElementsByTagName("button")[0].innerHTML
                    for(i=1;i<cells.length;i++){
                        if(day = dayRow[i].getElementsByTagName("button").length==0)continue
                        day = dayRow[i].getElementsByTagName("button")[0].innerHTML
                        buttons = cells[i].getElementsByTagName("button")
                        for(b=0;b<buttons.length;b++){
                            course = buttons[b].innerHTML
                            var code = day + time + course
                            // codes.push(code)
                            console.log(code)
                            buttons[b].setAttribute("onclick","changeDay('"+day+"','"+time+"','"+course+"')")                    
                        }
                    }
                }

                dialog.close()
            }

            function setOnclickOnTable(){
                table = document.getElementById("table")
                dayRow = document.getElementById("class-day-row").getElementsByTagName("th")

                tbody = document.getElementById("class-table-body")
                rows = tbody.getElementsByTagName("tr")
                for(k=0;k<rows.length;k++){
                    cells = rows[k].getElementsByTagName("td")
                    if(cells[0].getElementsByTagName("button").length==0)continue
                    time = cells[0].getElementsByTagName("button")[0].innerHTML
                    for(i=1;i<cells.length;i++){
                        if(day = dayRow[i].getElementsByTagName("button").length==0)continue
                        day = dayRow[i].getElementsByTagName("button")[0].innerHTML
                        buttons = cells[i].getElementsByTagName("button")
                        for(b=0;b<buttons.length;b++){
                            course = buttons[b].innerHTML
                            var code = day + time + course
                            // codes.push(code)
                            console.log(code)
                            buttons[b].setAttribute("onclick","showRollbook('"+day+"','"+time+"','"+course+"')")                    
                        }
                    }
                }
            }
            setOnclickOnTable()

            function showClassState(day, time, course){
                tableBody = document.getElementById("rollbook")
                tableBody.innerHTML = ""
                console.log("day="+day+", time="+time+", course="+course)
                states = weekData[day][time][course]
                for(name in states){
                    row = document.createElement("tr")
                    // add name
                    nameTd = document.createElement("td")
                    nameText = document.createTextNode(name)
                    nameTd.appendChild(nameText)
                    // add state
                    stateTd = document.createElement("td")
                    if(!states[name]){
                        // stateText = document.createTextNode(states[name])
                        stateTd.innerHTML = 
                        "<label class='mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect' for='checkbox-1'>\
                        <input type='checkbox' class='mdl-checkbox__input' checked disabled></label>"
                    }else{
                        stateTd.innerHTML = 
                        "<label class='mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect' for='checkbox-1'>\
                        <input type='checkbox' class='mdl-checkbox__input' disabled></label>"
                    }
                    // stateTd.appendChild(stateText)
                    
                    row.appendChild(nameTd)
                    row.appendChild(stateTd)
                    row.setAttribute("onclick", "setChangeDayMode('"+name+"')")
                    tableBody.appendChild(row)
                }
                dialog.showModal();
            }

          var dialog = document.querySelector('dialog');
          var showDialogButton = document.querySelector('#show-dialog');
          if (! dialog.showModal) {
            dialogPolyfill.registerDialog(dialog);
          }
          dialog.querySelector('.close').addEventListener('click', function() {
            dialog.close();
          });
        </script>
    </body>
</html>